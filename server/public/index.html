<!DOCTYPE html>
<html>

<head>
    <title>Wiim Now Playing (DEV)</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <style>
        html {
            min-height: 100%;
        }

        body {
            background-color: #333;
            background-image: linear-gradient(#033536, #010c12);
            color: #fff;
            min-height: 100%;
            font-family: arial, sans-serif;
        }

        #albumArt {
            max-height: 32px;
            border-radius: 5px;
        }
    </style>

</head>

<body>

    <h2>Wiim Now Playing (DEV)</h2>

    <p>State: <span id="sTimeStampDiff"></span></p>
    <textarea id="state" cols="80" rows="3"></textarea>

    <p>Metadata:</p>
    <textarea id="metadata" cols="80" rows="4"></textarea>
    <div>
        <span id="sTitle"></span>,
        <span id="sArtist"></span>,
        <span id="sAlbum"></span>
        <img id="albumArt" />
    </div>

    <p>Currently available devices:</p>
    <ul id="devices">
        <li><em>...</em></li>
    </ul>
    <div><button id="btnDevices">Get devices</button><button id="btnRefresh">Refresh devices</button></div>

    <p>Server Settings</p>
    <textarea id="serverSettings" cols="80" rows="4"></textarea>

    <p>Hardware (Pi only)</p>
    <div><button id="btnReboot" disabled>Reboot server</button><button id="btnShutdown" disabled>Shutdown
            server</button></div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        var socket = io();

        // DEBUG
        // var state = document.getElementById("state");
        // var btn = document.getElementById("btn");

        // UI event listeners

        btnDevices.addEventListener("click", function () {
            socket.emit("devices-get");
        });

        btnRefresh.addEventListener("click", function () {
            socket.emit("devices-refresh");
            // Wait for discovery to finish
            setTimeout(() => {
                socket.emit("devices-get");
            }, 5000);
        });

        btnReboot.addEventListener("click", function () {
            socket.emit("server-reboot");
        });

        btnShutdown.addEventListener("click", function () {
            socket.emit("server-shutdown");
        });

        // Sockets

        // Initial calls, wait a bit for socket to start
        setTimeout(() => {
            socket.emit("devices-get");
            socket.emit("server-settings");
        }, 500);

        socket.on("state", function (msg) {
            state.innerHTML = JSON.stringify(msg);
            var timeStampDiff = (msg.stateTimeStamp && msg.metadataTimeStamp) ? Math.round((msg.stateTimeStamp - msg.metadataTimeStamp) / 1000) : 0;
            sTimeStampDiff.innerHTML = "<em>diff = " + timeStampDiff + "s</em>";
        });

        socket.on("metadata", function (msg) {
            metadata.innerHTML = JSON.stringify(msg);
            sTitle.innerHTML = (msg.trackMetaData["dc:title"]) ? msg.trackMetaData["dc:title"] : "...";
            sArtist.innerHTML = (msg.trackMetaData["upnp:artist"]) ? msg.trackMetaData["upnp:artist"] : "...";
            sAlbum.innerHTML = (msg.trackMetaData["upnp:album"]) ? msg.trackMetaData["upnp:album"] : "...";
            if (msg.trackMetaData["upnp:albumArtURI"] && albumArt.src != msg.trackMetaData["upnp:albumArtURI"]) {
                albumArt.src = msg.trackMetaData["upnp:albumArtURI"];
            }
            else if (!msg.trackMetaData["upnp:albumArtURI"]) {
                albumArt.src = "";
            }
        });

        socket.on("devices-get", function (msg) {
            devices.innerHTML = "";
            msg.forEach(device => {
                var item = document.createElement('li');
                item.innerHTML = device.friendlyName;
                devices.appendChild(item);
            });
        });

        socket.on("devices-refresh", function (msg) {
            devices.innerHTML = "<li><em>" + msg + "</em></li>";
        });

        socket.on("server-settings", function (msg) {
            serverSettings.innerHTML = JSON.stringify(msg);
            if (msg.os.userInfo.shell === "/bin/bash") { // RPi has bash, so possibly able to reboot/shutdown.
                btnReboot.disabled = false;
                btnShutdown.disabled = false;
            };
        });

    </script>

</body>